# 개발 일지 - 2026년 1월 6일

## 작업 요약

1. **MusicPreset duration hint 추가** - 트랙 길이 일관성 개선
2. **사전 생성된 제목 캐시 경로 문제 해결**
3. **PM2 중복 프로세스 정리**
4. **iOS TestFlight 빌드 12 배포**

---

## 1. 트랙 길이 일관성 개선

### 문제
- Suno AI로 생성된 트랙 길이가 1분 ~ 7분으로 들쭉날쭉함
- 일관된 3-4분 길이의 트랙이 필요

### 원인 분석
- Suno API에는 직접적인 duration 파라미터가 없음
- 프롬프트 힌트를 통해 간접적으로 조절해야 함

### 해결 방법

#### 1-1. suno-client.ts의 HEALING_STYLES 수정

```typescript
// backend/src/lib/suno-client.ts

// Duration hint for consistent track length
const DURATION_HINT = ', 3-4 minutes long, extended composition';

export const HEALING_STYLES = {
  piano: 'Ambient, Relaxing, Piano, Soft, Peaceful' + DURATION_HINT,
  nature: 'Nature Sounds, Ambient, Birds, Water, Forest' + DURATION_HINT,
  meditation: 'Meditation, Tibetan Singing Bowls, Om, Drone, Peaceful' + DURATION_HINT,
  sleep: 'Sleep Music, Delta Waves, Soft, Dreamy, Ambient' + DURATION_HINT,
  focus: 'Lo-fi, Study, Chill, Minimal, Beats' + DURATION_HINT,
  cafe: 'Cafe Jazz, Acoustic, Warm, Cozy, Background' + DURATION_HINT,
  classical: 'Classical, Orchestra, Strings, Emotional, Cinematic' + DURATION_HINT,
  lofi: 'Lo-fi Hip Hop, Chill, Relaxed, Vinyl, Nostalgic' + DURATION_HINT,
};
```

#### 1-2. MusicPreset 데이터베이스 업데이트

**중요**: `music/route.ts`에서 MusicPreset 테이블의 stylePrompt가 HEALING_STYLES보다 우선 적용됨

```sql
-- 45개 MusicPreset 레코드 업데이트
UPDATE "MusicPreset"
SET "stylePrompt" = "stylePrompt" || ', 3-4 minutes long, extended composition'
WHERE "stylePrompt" NOT LIKE '%3-4 minutes%';
```

**결과 확인**:
```sql
SELECT "styleCode", "moodCode", "stylePrompt" FROM "MusicPreset" LIMIT 3;

-- 결과:
-- lofi | emotional | Lo-fi beats, chill hop, vinyl crackle, nostalgic, emotional, touching, heartfelt, lyrical, 3-4 minutes long, extended composition
-- piano | calm | Soft piano, gentle keys, melodic piano, calm, peaceful, tranquil, serene, 3-4 minutes long, extended composition
```

### 시행착오
- 처음에 `suno-client.ts`만 수정했으나 효과 없음
- `music/route.ts` 분석 결과, MusicPreset 테이블이 존재하면 해당 stylePrompt 사용
- DB의 MusicPreset도 함께 업데이트해야 함

### 주의사항
- Suno AI가 프롬프트를 100% 따르지는 않아 약간의 변동은 있을 수 있음
- 새로 생성되는 트랙부터 적용됨

---

## 2. 사전 생성된 제목 캐시 문제

### 문제
- 관리자 페이지에서 사전 생성된 제목이 0개로 표시됨
- 실제로는 48개가 남아있어야 함

### 원인 분석

#### 2-1. 제목 저장 방식 확인
- 제목은 **데이터베이스가 아닌 파일 시스템**에 저장됨
- 경로: `data/title-cache/{category}_titles.json`

```typescript
// backend/src/app/api/admin/generate/titles/route.ts
const CACHE_DIR = path.join(process.cwd(), 'data', 'title-cache');

function getCacheFilePath(category: string): string {
  return path.join(CACHE_DIR, `${category}_titles.json`);
}
```

#### 2-2. 경로 불일치 문제
- 실제 파일 위치: `/root/heeling/storage/data/title-cache/`
- 백엔드가 찾는 위치: `/root/heeling/backend/data/title-cache/`

### 해결 방법

#### 첫 번째 시도 (실패)
```bash
# .next/standalone 경로에 symlink 생성 - 잘못된 위치
ln -sf /root/heeling/storage/data/title-cache /root/heeling/backend/.next/standalone/backend/data/title-cache
```
**결과**: 여전히 0개로 표시

#### 두 번째 시도 (성공)
```bash
# PM2 실제 working directory 확인
pm2 show heeling-backend | grep "exec cwd"
# 결과: /root/heeling/backend

# 올바른 위치에 symlink 생성
mkdir -p /root/heeling/backend/data
ln -sf /root/heeling/storage/data/title-cache /root/heeling/backend/data/title-cache
```

### 시행착오
1. 처음에 `.next/standalone/` 경로에 symlink 생성 → 실패
2. PM2의 실제 working directory 확인 필요
3. `pm2 show <app-name> | grep "exec cwd"`로 정확한 경로 파악

### 최종 결과
- Total: 222개, Unused: 196개 정상 표시

---

## 3. PM2 중복 프로세스 정리

### 문제
- `pm2 status` 실행 시 heeling-backend 프로세스가 2개 표시
- id 0: errored 상태
- id 2: online 상태

### 해결 방법
```bash
# 에러 상태의 프로세스 삭제
pm2 delete 0

# PM2 설정 저장
pm2 save
```

### 원인 추정
- 이전 배포 시 프로세스가 제대로 종료되지 않고 새 프로세스 생성
- `pm2 restart` 대신 `pm2 start`가 실행되었을 가능성

### 예방 방법
```bash
# 항상 restart 사용
pm2 restart heeling-backend

# 또는 delete 후 start
pm2 delete heeling-backend
pm2 start npm --name "heeling-backend" -- run start
pm2 save
```

---

## 4. iOS TestFlight 빌드 12 배포

### 빌드 과정

#### 4-1. 버전 번호 증가
```bash
# mobile/ios/BRIBI/Info.plist
# CFBundleVersion: 11 → 12
sed -i '' 's/<string>11<\/string>/<string>12<\/string>/' BRIBI/Info.plist
```

#### 4-2. Pod 설치
```bash
cd mobile/ios
LANG=en_US.UTF-8 pod install
```

**시행착오**:
- `pod install` 실행 시 인코딩 에러 발생
- `LANG=en_US.UTF-8` 환경변수 설정으로 해결

#### 4-3. Archive 생성
```bash
cd mobile/ios
xcodebuild -workspace BRIBI.xcworkspace \
  -scheme BRIBI \
  -configuration Release \
  -destination generic/platform=iOS \
  archive \
  -archivePath ./build/BRIBI.xcarchive
```

**결과**: `** ARCHIVE SUCCEEDED **`

#### 4-4. App Store Connect 업로드

**터미널 시도 (실패)**:
```bash
xcodebuild -exportArchive \
  -archivePath ./build/BRIBI.xcarchive \
  -exportPath ./build/export \
  -exportOptionsPlist ExportOptions.plist
```

**에러**: `No Accounts with App Store Connect Access`
- 터미널에서 업로드하려면 App Store Connect API 키 설정 필요

**Xcode GUI 사용 (성공)**:
```bash
# Archive를 Xcode Organizer에서 열기
open ./build/BRIBI.xcarchive
```

1. Xcode Organizer에서 아카이브 선택
2. "Distribute App" 클릭
3. "App Store Connect" → "Upload" 선택
4. 자동 서명으로 진행

**경고 메시지**:
```
Upload Symbols Failed
The archive did not include a dSYM for the hermes.framework with the UUIDs [C44D5EEA-49FF-387A-B413-B31F880EC979].
```
- 이 경고는 무시해도 됨 (앱 실행에 영향 없음)
- Hermes 엔진의 디버그 심볼만 누락된 것

#### 4-5. 처리 완료
- 업로드 후 약 10분 대기
- App Store Connect에서 "완료" 상태 확인
- TestFlight에서 테스터 배포 가능

### 빌드 12 변경 내용
- 카테고리 동적 로드 (서버 API 연동)
- CategoryService: `fetchFromServer()`, `fetchAndSync()` 추가
- HomeScreen/LibraryScreen: 동적 카테고리 표시

---

## 배포 체크리스트

### 백엔드 (VPS)
- [x] MusicPreset DB 업데이트 (duration hint)
- [x] suno-client.ts 수정 (HEALING_STYLES)
- [x] title-cache symlink 생성
- [x] PM2 재시작
- [x] 중복 프로세스 정리

### iOS (TestFlight)
- [x] Info.plist 버전 증가 (12)
- [x] pod install
- [x] Archive 생성
- [x] App Store Connect 업로드
- [x] TestFlight 처리 완료

---

## 참고 명령어

### VPS 서버 접속
```bash
ssh root@141.164.60.51
```

### PM2 관리
```bash
pm2 status                    # 상태 확인
pm2 logs heeling-backend      # 로그 확인
pm2 restart heeling-backend   # 재시작
pm2 show heeling-backend      # 상세 정보
```

### 데이터베이스 쿼리
```bash
# VPS에서 실행
PGPASSWORD=$(grep DATABASE_URL .env | sed 's/.*:\/\/[^:]*:\([^@]*\)@.*/\1/') \
psql -h localhost -U heeling -d heeling_db -c "YOUR_QUERY"
```

### iOS 빌드
```bash
cd mobile/ios
LANG=en_US.UTF-8 pod install
xcodebuild -workspace BRIBI.xcworkspace -scheme BRIBI -configuration Release -destination generic/platform=iOS archive -archivePath ./build/BRIBI.xcarchive
```
