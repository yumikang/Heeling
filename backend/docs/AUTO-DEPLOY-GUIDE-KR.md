# Heeling ìë™ ë°°í¬ ì‹œìŠ¤í…œ ì™„ë²½ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [ì „ì²´ í”Œë¡œìš°](#ì „ì²´-í”Œë¡œìš°)
3. [í•µì‹¬ ì»´í¬ë„ŒíŠ¸](#í•µì‹¬-ì»´í¬ë„ŒíŠ¸)
4. [ë°ì´í„° êµ¬ì¡°](#ë°ì´í„°-êµ¬ì¡°)
5. [API ì—”ë“œí¬ì¸íŠ¸](#api-ì—”ë“œí¬ì¸íŠ¸)
6. [ë°°í¬ í”„ë¡œì„¸ìŠ¤](#ë°°í¬-í”„ë¡œì„¸ìŠ¤)
7. [ì—ëŸ¬ ì²˜ë¦¬](#ì—ëŸ¬-ì²˜ë¦¬)
8. [ë¡œì»¬ í…ŒìŠ¤íŠ¸](#ë¡œì»¬-í…ŒìŠ¤íŠ¸)
9. [VPS ë°°í¬](#vps-ë°°í¬)
10. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ì‹œìŠ¤í…œ ê°œìš”

### ëª©ì 
Suno AIë¥¼ ì´ìš©í•œ íë§ ìŒì•… ìƒì„± ë° ìë™ ë°°í¬ ì‹œìŠ¤í…œ

### ì£¼ìš” íŠ¹ì§•
- **ì œëª© ìºì‹œ ì‹œìŠ¤í…œ**: AIê°€ ë¯¸ë¦¬ ìƒì„±í•œ ì°½ì˜ì ì¸ ì œëª© ì‚¬ìš©
- **2íŠ¸ë™ ë™ì‹œ ì²˜ë¦¬**: Suno 1íšŒ í˜¸ì¶œë¡œ 2ê°œ íŠ¸ë™ ìƒì„± ë° ë°°í¬
- **ìë™ ì´ë¯¸ì§€ ìƒì„±**: Gemini Imagenìœ¼ë¡œ ê° íŠ¸ë™ë³„ ì»¤ë²„ ì´ë¯¸ì§€ ìƒì„±
- **Retry ë©”ì»¤ë‹ˆì¦˜**: ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)
- **Zombie ê°ì§€**: 1ì‹œê°„ ì´ìƒ ì§„í–‰ ì—†ëŠ” ì‘ì—… ìë™ ì‹¤íŒ¨ ì²˜ë¦¬

---

## ì „ì²´ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ìŠ¤ì¼€ì¤„ ì„¤ì • (ê´€ë¦¬ì í˜ì´ì§€)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€ ìŠ¤ì¼€ì¤„ ì´ë¦„: "ë§¤ì¼ ì•„ì¹¨ íë§ ìŒì•…"
   â”œâ”€ ë¹ˆë„: daily/weekly/monthly/once
   â”œâ”€ ìƒì„± ê°œìˆ˜: 1-10 (ê° ê°œìˆ˜ë‹¹ 2íŠ¸ë™ ìƒì„±)
   â”œâ”€ ìŠ¤íƒ€ì¼/ë¶„ìœ„ê¸°: piano/calm ë“±
   â””â”€ ìë™ ë°°í¬: ON/OFF
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ìˆ˜ë™ ë˜ëŠ” ì˜ˆì•½)                             â”‚
â”‚ POST /api/admin/generate/schedules/run                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€ ì œëª© ìºì‹œì—ì„œ 2ê°œ ì œëª© ì¡°íšŒ
   â”‚  GET /api/admin/generate/titles?category=healing&count=2
   â”‚  â†’ ì˜ˆ: ["Whispers of Dawn", "Piano in the Mist"]
   â”‚
   â”œâ”€ Suno API í˜¸ì¶œ (ì²« ë²ˆì§¸ ì œëª©ìœ¼ë¡œ)
   â”‚  POST https://api.sunoaiapi.com/api/v1/gateway/generate/music
   â”‚  â†’ taskId: "abc123" ë°›ìŒ
   â”‚
   â”œâ”€ GenerationTask 2ê°œ ìƒì„± (autoDeploy=true)
   â”‚  â”œâ”€ Task 1: taskId=abc123, trackIndex=0, title="Whispers of Dawn"
   â”‚  â””â”€ Task 2: taskId=abc123, trackIndex=1, title="Piano in the Mist"
   â”‚
   â””â”€ ì‚¬ìš©í•œ ì œëª© ìºì‹œì—ì„œ ë§ˆí‚¹
      POST /api/admin/generate/titles (action: markUsed)
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (5ë¶„ë§ˆë‹¤ - cron)                  â”‚
â”‚ node scripts/check-and-deploy.js                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€ DBì—ì„œ PENDING/GENERATING ìƒíƒœ Task ì¡°íšŒ
   â”‚  SELECT * FROM GenerationTask
   â”‚  WHERE autoDeploy=true AND status IN (...)
   â”‚
   â”œâ”€ taskIdë³„ ê·¸ë£¹í™” (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€)
   â”‚  taskId=abc123 â†’ [Task1(idx=0), Task2(idx=1)]
   â”‚
   â”œâ”€ Suno ìƒíƒœ ì²´í¬
   â”‚  GET https://api.sunoaiapi.com/api/v1/gateway/query?ids=abc123
   â”‚  â†’ status: PENDING â†’ GENERATING â†’ SUCCESS
   â”‚
   â””â”€ SUCCESSì¼ ë•Œ ë°°í¬ ì‹œì‘
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ë‹¨ê³„: 2ê°œ íŠ¸ë™ ë‹¤ìš´ë¡œë“œ ë° ë°°í¬                                â”‚
â”‚ downloadAndDeploy([Task1, Task2], sunoData)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   FOR EACH Track (0, 1):
   â”‚
   â”œâ”€ Gemini ì´ë¯¸ì§€ ìƒì„± (ê° íŠ¸ë™ë³„ ì œëª© ê¸°ë°˜)
   â”‚  POST https://generativelanguage.googleapis.com/.../imagen-4.0
   â”‚  prompt: "Whispers of Dawn" í…Œë§ˆ ë°˜ì˜
   â”‚  â†’ cover_abc123_0_1701234567.png ì €ì¥
   â”‚
   â”œâ”€ Suno ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
   â”‚  GET sunoData.tracks[trackIndex].streamAudioUrl
   â”‚  â†’ abc123_1701234567.mp3 ì €ì¥
   â”‚
   â”œâ”€ ì˜¤ë””ì˜¤ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
   â”‚  music-metadata ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ duration ì¶”ì¶œ
   â”‚  â†’ ì˜ˆ: 180ì´ˆ
   â”‚
   â”œâ”€ Track í…Œì´ë¸”ì— ì‚½ì…
   â”‚  INSERT INTO Track (
   â”‚    title: "Whispers of Dawn",
   â”‚    fileUrl: "/media/tracks/abc123_0.mp3",
   â”‚    thumbnailUrl: "/media/covers/cover_0.png",
   â”‚    duration: 180,
   â”‚    ...
   â”‚  )
   â”‚
   â””â”€ GenerationTask ìƒíƒœ ì—…ë°ì´íŠ¸
      UPDATE GenerationTask
      SET status='DEPLOYED'
      WHERE id=Task.id
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ë‹¨ê³„: ì™„ë£Œ (ì•±ì—ì„œ ì¦‰ì‹œ ì¬ìƒ ê°€ëŠ¥)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í•µì‹¬ ì»´í¬ë„ŒíŠ¸

### 1. ì œëª© ìºì‹œ ì‹œìŠ¤í…œ

**íŒŒì¼ ìœ„ì¹˜**: `data/title-cache/healing_titles.json`

**êµ¬ì¡°**:
```json
{
  "category": "healing",
  "generatedAt": "2024-12-03T12:00:00Z",
  "titles": [
    {
      "ko": "ìƒˆë²½ì„ ì—¬ëŠ” ë©œë¡œë””",
      "en": "Whispers of Dawn",
      "keywords": "ìƒˆë²½, ë©œë¡œë””, í‰í™”",
      "used": false,
      "usedAt": null
    },
    {
      "ko": "ì•ˆê°œ ì† í”¼ì•„ë…¸",
      "en": "Piano in the Mist",
      "keywords": "ì•ˆê°œ, í”¼ì•„ë…¸, ì‹ ë¹„",
      "used": true,
      "usedAt": "2024-12-03T14:30:00Z"
    }
  ]
}
```

**ì‚¬ìš© íë¦„**:
1. **ìƒì„±**: ê´€ë¦¬ì í˜ì´ì§€ â†’ "50ê°œ ìƒì„±" ë²„íŠ¼
2. **ì¡°íšŒ**: `GET /api/admin/generate/titles?category=healing&count=2`
3. **ë§ˆí‚¹**: `POST /api/admin/generate/titles` (action: markUsed)
4. **ê³µìœ **: ìˆ˜ë™ ìƒì„± + ìë™ ìƒì„± ëª¨ë‘ ë™ì¼ ìºì‹œ ì‚¬ìš©

**ì¥ì **:
- AIê°€ ìƒì„±í•œ ì°½ì˜ì ì´ê³  ì‹œì ì¸ ì œëª©
- "íë§ ìŒì•… 1", "Healing Music 2" ê°™ì€ ë‹¨ìˆœ ì œëª© ë°©ì§€
- ì‚¬ì „ ìƒì„±ìœ¼ë¡œ ìŒì•… ìƒì„± ì‹œ ì§€ì—° ì—†ìŒ

---

### 2. GenerationTask ëª¨ë¸

**ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”**: `GenerationTask`

**ì£¼ìš” í•„ë“œ**:
```prisma
model GenerationTask {
  id            String   // cuid: "clq1x2y3z4..."
  scheduleId    String?  // ì–´ëŠ ìŠ¤ì¼€ì¤„ì—ì„œ ìƒì„±ë˜ì—ˆëŠ”ì§€

  // Suno ì‹ë³„ì (2ê°œ Taskê°€ ë™ì¼í•œ taskId ê³µìœ )
  taskId        String   // "abc123"
  trackIndex    Int      // 0 or 1

  // íŠ¸ë™ ì •ë³´
  title         String   // "Whispers of Dawn"
  style         String   // "piano"
  mood          String   // "calm"

  // ìƒíƒœ ì¶”ì 
  status        GenerationStatus  // PENDING â†’ GENERATING â†’ GENERATED â†’ DOWNLOADING â†’ DEPLOYING â†’ DEPLOYED
  retryCount    Int      // 0-3
  maxRetries    Int      // 3

  // Suno URL (ì›ë³¸ ë³´ì¡´)
  sunoAudioUrl  String?
  sunoImageUrl  String?

  // ë¡œì»¬ ì €ì¥ URL
  audioUrl      String?  // "/media/tracks/abc123_0.mp3"
  imageUrl      String?  // "/media/covers/cover_0.png"

  // ë©”íƒ€ë°ì´í„°
  duration      Int?     // 180 (ì´ˆ)

  // íƒ€ì„ìŠ¤íƒ¬í”„
  lastCheckedAt DateTime?
  failedAt      DateTime?
  error         String?
  createdAt     DateTime
  updatedAt     DateTime

  // í”Œë˜ê·¸
  autoDeploy    Boolean  // true

  @@unique([taskId, trackIndex])  // ë³µí•© unique: ê°™ì€ taskIdë¡œ 2ê°œ íŠ¸ë™
}
```

**ìƒíƒœ ì „ì´**:
```
PENDING (Suno í˜¸ì¶œ ì™„ë£Œ)
   â†“
GENERATING (Suno ìƒì„± ì¤‘)
   â†“
GENERATED (Suno ì™„ë£Œ, URL í™•ì¸)
   â†“
DOWNLOADING (ë¡œì»¬ ì €ì¥ ì¤‘)
   â†“
DEPLOYING (Track í…Œì´ë¸” ì‚½ì… ì¤‘)
   â†“
DEPLOYED (ì™„ë£Œ)

ë˜ëŠ”
   â†“
FAILED (maxRetries ì´ˆê³¼ ë˜ëŠ” zombie timeout)
```

---

### 3. ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

**íŒŒì¼**: `scripts/check-and-deploy.js`

**ì£¼ìš” í•¨ìˆ˜**:

#### `main()`
- DBì—ì„œ ì²˜ë¦¬ ëŒ€ìƒ Task ì¡°íšŒ
- taskIdë³„ ê·¸ë£¹í™” (ì¤‘ë³µ ì œê±°)
- ìˆœì°¨ ì²˜ë¦¬ (1ì´ˆ ê°„ê²©)

#### `processTask(task)`
- taskIdë¡œ ì—°ê´€ Task ì „ì²´ ì¡°íšŒ
- Suno ìƒíƒœ ì²´í¬
- Zombie timeout ì²´í¬ (1ì‹œê°„)
- ìƒíƒœë³„ ì²˜ë¦¬:
  - PENDING/RUNNING: ìƒíƒœ ì—…ë°ì´íŠ¸ë§Œ
  - SUCCESS: downloadAndDeploy í˜¸ì¶œ
  - FAILED: Retry ë˜ëŠ” ìµœì¢… ì‹¤íŒ¨

#### `downloadAndDeploy(tasks, sunoData)`
- 2ê°œ íŠ¸ë™ ìˆœíšŒ ì²˜ë¦¬
- ê° íŠ¸ë™ë³„:
  1. Gemini ì´ë¯¸ì§€ ìƒì„±
  2. Suno ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
  3. Duration ì¶”ì¶œ
  4. ë¡œì»¬ ì €ì¥ (public/media/)
  5. Track í…Œì´ë¸” ì‚½ì…
  6. GenerationTask ìƒíƒœ ì—…ë°ì´íŠ¸

#### `generateGeminiImage(title)`
- ì œëª© ë¶„ì„í•˜ì—¬ í…Œë§ˆ ê°ì§€
- í…Œë§ˆë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
- Gemini Imagen 4.0 í˜¸ì¶œ
- Base64 ì´ë¯¸ì§€ ë°˜í™˜

#### `downloadWithRetry(url, maxRetries)`
- Exponential backoff retry
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ëŒ€ì‘

#### `extractDuration(audioBuffer)`
- music-metadata ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
- MP3 íŒŒì¼ì—ì„œ duration ì¶”ì¶œ

---

## ë°ì´í„° êµ¬ì¡°

### Suno API ì‘ë‹µ

**ìƒì„± ìš”ì²­**:
```json
POST https://api.sunoaiapi.com/api/v1/gateway/generate/music
{
  "title": "Whispers of Dawn",
  "prompt": "Instrumental healing music...",
  "style": "Ambient, relaxing piano...",
  "instrumental": true,
  "custom_mode": false,
  "mv": "chirp-v5"
}

Response:
{
  "code": 200,
  "data": {
    "taskId": "abc123"
  }
}
```

**ìƒíƒœ ì¡°íšŒ**:
```json
GET https://api.sunoaiapi.com/api/v1/gateway/query?ids=abc123

Response:
{
  "code": 200,
  "data": {
    "taskId": "abc123",
    "status": "SUCCESS",
    "response": {
      "sunoData": [
        {
          "id": "track001",
          "title": "Whispers of Dawn",
          "streamAudioUrl": "https://cdn.suno.ai/abc123_0.mp3",
          "image_url": "https://cdn.suno.ai/abc123_0.png",
          "duration": 180.5,
          "tags": "piano, calm, healing"
        },
        {
          "id": "track002",
          "title": "Whispers of Dawn",
          "streamAudioUrl": "https://cdn.suno.ai/abc123_1.mp3",
          "image_url": "https://cdn.suno.ai/abc123_1.png",
          "duration": 185.2,
          "tags": "piano, calm, healing"
        }
      ]
    }
  }
}
```

### Track í…Œì´ë¸” êµ¬ì¡°

```prisma
model Track {
  id            String   // "clq1x2y3z4..."
  title         String   // "Whispers of Dawn"
  artist        String   // "Heeling"
  composer      String   // "Heeling Studio"
  createdWith   String   // "Suno AI"

  fileUrl       String   // "/media/tracks/abc123_0_1701234567.mp3"
  thumbnailUrl  String   // "/media/covers/cover_0_1701234567.png"

  duration      Int      // 180 (ì´ˆ)
  fileSize      Int?     // bytes (ì„ íƒ)

  category      String   // "piano"
  tags          String[] // ["piano", "calm", "ai-generated"]
  mood          String   // "calm"

  playCount     Int      // 0
  likeCount     Int      // 0
  isActive      Boolean  // true

  createdAt     DateTime
  updatedAt     DateTime
}
```

---

## API ì—”ë“œí¬ì¸íŠ¸

### 1. ì œëª© API

#### `GET /api/admin/generate/titles`
**ìš©ë„**: ì‚¬ìš© ê°€ëŠ¥í•œ ì œëª© ì¡°íšŒ

**íŒŒë¼ë¯¸í„°**:
- `category`: "healing" (ê³ ì •)
- `count`: ê°€ì ¸ì˜¬ ê°œìˆ˜ (ê¸°ë³¸: 1)

**ì‘ë‹µ**:
```json
{
  "success": true,
  "data": {
    "available": 165,
    "total": 200,
    "titles": [
      {
        "ko": "ìƒˆë²½ì„ ì—¬ëŠ” ë©œë¡œë””",
        "en": "Whispers of Dawn",
        "keywords": "ìƒˆë²½, ë©œë¡œë””, í‰í™”"
      },
      {
        "ko": "ì•ˆê°œ ì† í”¼ì•„ë…¸",
        "en": "Piano in the Mist",
        "keywords": "ì•ˆê°œ, í”¼ì•„ë…¸, ì‹ ë¹„"
      }
    ],
    "needsGeneration": false,
    "generatedAt": "2024-12-03T12:00:00Z"
  }
}
```

#### `POST /api/admin/generate/titles`
**ìš©ë„ 1**: ì œëª© ëŒ€ëŸ‰ ìƒì„±

**ìš”ì²­**:
```json
{
  "category": "healing",
  "mood": "calm",
  "style": "piano",
  "count": 50
}
```

**ìš©ë„ 2**: ì‚¬ìš©ëœ ì œëª© ë§ˆí‚¹

**ìš”ì²­**:
```json
{
  "action": "markUsed",
  "category": "healing",
  "titleIds": ["Whispers of Dawn", "Piano in the Mist"]
}
```

---

### 2. ìŠ¤ì¼€ì¤„ API

#### `POST /api/admin/generate/schedules/run`
**ìš©ë„**: ìŠ¤ì¼€ì¤„ ì¦‰ì‹œ ì‹¤í–‰

**ìš”ì²­**:
```json
{
  "scheduleId": "schedule_123",
  "generateConfig": {
    "style": "piano",
    "mood": "calm",
    "instrumental": true
  }
}
```

**ì‘ë‹µ**:
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "taskId": "abc123",
        "status": "PENDING",
        "iteration": 1,
        "titles": ["Whispers of Dawn", "Piano in the Mist"]
      }
    ],
    "totalGenerations": 1,
    "expectedTracks": 2,
    "message": "Started 1 generation(s). Expected 2 tracks."
  }
}
```

---

### 3. ìŒì•… ìƒì„± API

#### `POST /api/admin/generate/music`
**ìš©ë„**: ìˆ˜ë™ ìŒì•… ìƒì„± (ê´€ë¦¬ì í˜ì´ì§€)

#### `GET /api/admin/generate/music?taskId=abc123`
**ìš©ë„**: ìƒì„± ìƒíƒœ ì¡°íšŒ

---

## ë°°í¬ í”„ë¡œì„¸ìŠ¤

### ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…

#### **PENDING â†’ GENERATING**
```javascript
// check-and-deploy.js
const sunoResponse = await checkSunoStatus(task.taskId);
const sunoStatus = sunoResponse.data?.status;

if (sunoStatus === 'PENDING' || sunoStatus === 'RUNNING') {
  await prisma.generationTask.updateMany({
    where: { taskId: task.taskId },
    data: {
      status: 'GENERATING',
      lastCheckedAt: new Date()
    }
  });
}
```

**ì†Œìš” ì‹œê°„**: Suno ìƒì„± ì‹œê°„ (í‰ê·  1-3ë¶„)

---

#### **GENERATING â†’ GENERATED**
```javascript
if (sunoStatus === 'SUCCESS' || sunoStatus === 'TEXT_SUCCESS') {
  const allTasks = await prisma.generationTask.findMany({
    where: { taskId: task.taskId, autoDeploy: true },
    orderBy: { trackIndex: 'asc' }
  });

  await downloadAndDeploy(allTasks, sunoResponse.data);
}
```

**ì‘ì—…**: 2ê°œ íŠ¸ë™ ë‹¤ìš´ë¡œë“œ ë° ë°°í¬ ì‹œì‘

---

#### **GENERATED â†’ DOWNLOADING**
```javascript
// ê° íŠ¸ë™ë³„ ì²˜ë¦¬
for (const task of tasks) {
  const trackIndex = task.trackIndex;
  const sunoTrack = tracks[trackIndex];

  // 1. Gemini ì´ë¯¸ì§€ ìƒì„±
  const imageBuffer = await generateGeminiImage(task.title);
  const imageUrl = await saveToLocal(imageBuffer, ...);

  await prisma.generationTask.update({
    where: { id: task.id },
    data: {
      status: 'DOWNLOADING',
      imageUrl,
      lastCheckedAt: new Date()
    }
  });

  // 2. ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
  const audioBuffer = await downloadWithRetry(sunoAudioUrl, 3);
  const duration = await extractDuration(audioBuffer);
  const audioUrl = await saveToLocal(audioBuffer, ...);
}
```

**ì†Œìš” ì‹œê°„**: Gemini (3-5ì´ˆ) + ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ (2-10ì´ˆ)

---

#### **DOWNLOADING â†’ DEPLOYING**
```javascript
await prisma.generationTask.update({
  where: { id: task.id },
  data: {
    status: 'DEPLOYING',
    audioUrl,
    duration,
    lastCheckedAt: new Date()
  }
});
```

**ì‘ì—…**: Track í…Œì´ë¸” ì‚½ì… ì¤€ë¹„

---

#### **DEPLOYING â†’ DEPLOYED**
```javascript
// Track í…Œì´ë¸” ì‚½ì…
const trackData = {
  title: task.title,
  artist: 'Heeling',
  composer: 'Heeling Studio',
  createdWith: 'Suno AI',
  fileUrl: audioUrl,
  thumbnailUrl: imageUrl,
  duration,
  category: task.style || 'healing',
  tags: [task.style, task.mood, 'ai-generated'].filter(Boolean),
  mood: task.mood || 'calm',
  isActive: true
};

const createdTrack = await prisma.track.create({ data: trackData });

// GenerationTask ì™„ë£Œ ì²˜ë¦¬
await prisma.generationTask.update({
  where: { id: task.id },
  data: {
    status: 'DEPLOYED',
    lastCheckedAt: new Date()
  }
});
```

**ì™„ë£Œ**: ì•±ì—ì„œ ì¦‰ì‹œ ì¬ìƒ ê°€ëŠ¥

---

### ì „ì²´ íƒ€ì„ë¼ì¸

```
T+0ë¶„:    ìŠ¤ì¼€ì¤„ ì‹¤í–‰ â†’ GenerationTask 2ê°œ ìƒì„± (PENDING)
T+5ë¶„:    Cron ì‹¤í–‰ â†’ Suno ìƒíƒœ ì²´í¬ (GENERATING)
T+8ë¶„:    Cron ì‹¤í–‰ â†’ Suno ì™„ë£Œ í™•ì¸ (SUCCESS)
          â†’ 2ê°œ íŠ¸ë™ ë‹¤ìš´ë¡œë“œ ì‹œì‘
T+8ë¶„30ì´ˆ: Gemini ì´ë¯¸ì§€ 2ê°œ ìƒì„± ì™„ë£Œ
T+9ë¶„:    ì˜¤ë””ì˜¤ 2ê°œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ
T+9ë¶„10ì´ˆ: Track í…Œì´ë¸” 2ê°œ ë ˆì½”ë“œ ì‚½ì…
          â†’ ë°°í¬ ì™„ë£Œ (DEPLOYED)
```

**ì´ ì†Œìš” ì‹œê°„**: ì•½ 9-10ë¶„ (Suno ìƒì„± ì‹œê°„ì— ë”°ë¼ ë³€ë™)

---

## ì—ëŸ¬ ì²˜ë¦¬

### 1. Retry ë©”ì»¤ë‹ˆì¦˜

```javascript
// Suno ìƒì„± ì‹¤íŒ¨ ì‹œ
if (sunoStatus === 'FAILED') {
  if (task.retryCount < task.maxRetries) {
    // Retry
    await prisma.generationTask.updateMany({
      where: { taskId: task.taskId },
      data: {
        retryCount: task.retryCount + 1,
        status: 'PENDING',
        error: 'Suno generation failed, retrying...',
        lastCheckedAt: new Date()
      }
    });
  } else {
    // ìµœì¢… ì‹¤íŒ¨
    await prisma.generationTask.updateMany({
      where: { taskId: task.taskId },
      data: {
        status: 'FAILED',
        failedAt: new Date(),
        error: 'Suno generation failed after maximum retries'
      }
    });
  }
}
```

**Retry ì „ëµ**:
- ìµœëŒ€ 3íšŒ ì¬ì‹œë„
- Suno FAILED ìƒíƒœ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ
- Exponential backoff (ë‹¤ìš´ë¡œë“œ ì‹œ)

---

### 2. Zombie Timeout

```javascript
if (task.status === 'GENERATING' || task.status === 'PENDING') {
  const hoursSinceCreation =
    (Date.now() - new Date(task.createdAt).getTime()) / (1000 * 60 * 60);

  if (hoursSinceCreation > CONFIG.ZOMBIE_TIMEOUT_HOURS) {
    await prisma.generationTask.update({
      where: { id: task.id },
      data: {
        status: 'FAILED',
        failedAt: new Date(),
        error: `Timeout: No progress after ${CONFIG.ZOMBIE_TIMEOUT_HOURS} hour(s)`
      }
    });
  }
}
```

**Zombie ì¡°ê±´**:
- PENDING ë˜ëŠ” GENERATING ìƒíƒœ
- 1ì‹œê°„ ì´ìƒ ê²½ê³¼
- lastCheckedAt ì—…ë°ì´íŠ¸ ì—†ìŒ

**ì²˜ë¦¬**:
- ìë™ FAILED ì²˜ë¦¬
- Slack ì•Œë¦¼ (ì„¤ì • ì‹œ)

---

### 3. Gemini ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨

```javascript
try {
  const imageBuffer = await generateGeminiImage(task.title);
  imageUrl = await saveToLocal(imageBuffer, ...);
} catch (imageError) {
  console.warn(`Gemini image generation failed (non-critical):`, imageError.message);
  // ì´ë¯¸ì§€ ì—†ì´ ê³„ì† ì§„í–‰
  imageUrl = null;
}
```

**ì „ëµ**:
- Non-critical ì˜¤ë¥˜ë¡œ ì²˜ë¦¬
- ì´ë¯¸ì§€ ì—†ì´ ë°°í¬ ì§„í–‰
- Track.thumbnailUrl = null

---

### 4. ì œëª© ìºì‹œ ë¶€ì¡±

```javascript
if (titlesData.success && titlesData.data.titles?.length >= 2) {
  trackTitles = titlesData.data.titles.slice(0, 2);
} else {
  // Fallback
  trackTitles = [
    { ko: `${title} #1`, en: `${title} #1`, keywords: title },
    { ko: `${title} #2`, en: `${title} #2`, keywords: title }
  ];
}
```

**Fallback ì „ëµ**:
- ìŠ¤ì¼€ì¤„ ì´ë¦„ ê¸°ë°˜ ì œëª© ìƒì„±
- `#1`, `#2` ì ‘ë¯¸ì‚¬ ì¶”ê°€
- ì •ìƒ ë°°í¬ ì§„í–‰

---

## ë¡œì»¬ í…ŒìŠ¤íŠ¸

### í™˜ê²½ ì„¤ì •

**1. í™˜ê²½ë³€ìˆ˜ (.env)**:
```bash
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/heeling_db"

# Suno API
SUNO_API_KEY="your_suno_api_key_here"

# Gemini API
GEMINI_API_KEY="your_gemini_api_key_here"

# Slack (ì„ íƒ)
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/..."
```

**2. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜**:
```bash
npm run db:migrate
npx prisma generate
```

---

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### **ì‹œë‚˜ë¦¬ì˜¤ 1: ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸**

```bash
# Terminal 1: ì„œë²„ ì‹¤í–‰
npm run dev

# Terminal 2: ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ê´€ë¦¬ì í˜ì´ì§€)
# http://localhost:3002/admin/generate
# â†’ AI ìŒì•… â†’ ìŠ¤ì¼€ì¤„ â†’ ì‹¤í–‰ ë²„íŠ¼

# Terminal 3: Auto-deploy 1íšŒ ì‹¤í–‰
npm run deploy:check
```

**í™•ì¸ ì‚¬í•­**:
```sql
-- GenerationTask í™•ì¸
SELECT id, taskId, trackIndex, title, status
FROM "GenerationTask"
WHERE autoDeploy = true
ORDER BY createdAt DESC
LIMIT 10;

-- Track í™•ì¸
SELECT id, title, fileUrl, thumbnailUrl, duration
FROM "Track"
ORDER BY createdAt DESC
LIMIT 10;
```

---

#### **ì‹œë‚˜ë¦¬ì˜¤ 2: Watch ëª¨ë“œ (30ì´ˆ ê°„ê²©)**

```bash
npm run deploy:watch
```

**ë¡œê·¸ í™•ì¸**:
```
[TaskID abc123] Processing 2 tasks...
  - Task clq1x2y3z4... (trackIndex 0): Whispers of Dawn
  - Task clq5a6b7c8... (trackIndex 1): Piano in the Mist
[TaskID abc123] â³ Still generating...

... 30ì´ˆ í›„ ...

[TaskID abc123] âœ… Generation complete, deploying both tracks...
[Deploy] Starting for taskId abc123 (2 tracks)
[Deploy] Processing track 0: Whispers of Dawn
[Deploy] Generating cover image with Gemini for: Whispers of Dawn
[Deploy] Cover image generated and saved: /media/covers/...
[Deploy] Downloading audio: https://cdn.suno.ai/...
[Deploy] Duration: 180s
[Deploy] âœ… Track created: clq9x0y1z2... (Whispers of Dawn)
[Deploy] Processing track 1: Piano in the Mist
[Deploy] Generating cover image with Gemini for: Piano in the Mist
[Deploy] Cover image generated and saved: /media/covers/...
[Deploy] Downloading audio: https://cdn.suno.ai/...
[Deploy] Duration: 185s
[Deploy] âœ… Track created: clq3a4b5c6... (Piano in the Mist)
[Deploy] âœ… All tracks deployed for taskId abc123
```

---

#### **ì‹œë‚˜ë¦¬ì˜¤ 3: ì œëª© ìºì‹œ í…ŒìŠ¤íŠ¸**

```bash
# 1. ì œëª© ìºì‹œ ìƒíƒœ í™•ì¸
curl http://localhost:3002/api/admin/generate/titles?category=healing

# 2. ì œëª© ìºì‹œ ìƒì„± (ë¶€ì¡±í•  ê²½ìš°)
# ê´€ë¦¬ì í˜ì´ì§€ â†’ AI ìŒì•… â†’ "50ê°œ ìƒì„±" ë²„íŠ¼

# 3. ìŠ¤ì¼€ì¤„ ì‹¤í–‰ í›„ ë¡œê·¸ í™•ì¸
[Schedule Run] Using titles from cache: Whispers of Dawn, Piano in the Mist
```

---

#### **ì‹œë‚˜ë¦¬ì˜¤ 4: ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤**

**Retry í…ŒìŠ¤íŠ¸**:
```bash
# Suno API í‚¤ë¥¼ ì˜ëª»ëœ ê°’ìœ¼ë¡œ ë³€ê²½
# â†’ 3íšŒ ì¬ì‹œë„ í›„ FAILED í™•ì¸

# ë¡œê·¸:
[TaskID abc123] âŒ Suno generation failed
[TaskID abc123] ğŸ”„ Retry 1/3
... 5ë¶„ í›„ ...
[TaskID abc123] ğŸ”„ Retry 2/3
... 5ë¶„ í›„ ...
[TaskID abc123] ğŸ”„ Retry 3/3
... 5ë¶„ í›„ ...
[TaskID abc123] â›” Max retries reached
```

**Zombie Timeout í…ŒìŠ¤íŠ¸**:
```bash
# GenerationTaskë¥¼ PENDING ìƒíƒœë¡œ 1ì‹œê°„ ì´ìƒ ë°©ì¹˜
# â†’ Zombie ê°ì§€ í™•ì¸

# ë¡œê·¸:
[Task clq1x2y3z4...] ğŸ§Ÿ Zombie detected: 1.23h old
[Task clq1x2y3z4...] âŒ Failed: Timeout after 1 hour(s)
```

---

## VPS ë°°í¬

### 1. VPS í™˜ê²½ ì„¤ì •

```bash
# í”„ë¡œì íŠ¸ í´ë¡ 
cd /home/user
git clone https://github.com/your-repo/heeling.git
cd heeling/backend

# Node.js 18+ ì„¤ì¹˜ í™•ì¸
node --version  # v18.x.x ì´ìƒ

# ì˜ì¡´ì„± ì„¤ì¹˜
npm install

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
cp .env.example .env
nano .env
# â†’ DATABASE_URL, SUNO_API_KEY, GEMINI_API_KEY ì„¤ì •

# DB ë§ˆì´ê·¸ë ˆì´ì…˜
npm run db:migrate

# Prisma Client ìƒì„±
npx prisma generate
```

---

### 2. Crontab ì„¤ì •

```bash
# Crontab í¸ì§‘
crontab -e

# 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
*/5 * * * * /home/user/heeling/backend/scripts/heeling-auto-deploy.sh >> /var/log/heeling-auto-deploy.log 2>&1
```

**Wrapper Script** (`scripts/heeling-auto-deploy.sh`):
```bash
#!/bin/bash
PROJECT_ROOT="/home/user/heeling/backend"
SCRIPT_PATH="$PROJECT_ROOT/scripts/check-and-deploy.js"
LOCK_FILE="/tmp/heeling-auto-deploy.lock"

# Lock íšë“ (flock ì‚¬ìš©)
exec 9>"$LOCK_FILE"
if ! flock -n 9; then
  echo "Another instance is running"
  exit 1
fi

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
cd "$PROJECT_ROOT"
source .env

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
node "$SCRIPT_PATH"

# Lock í•´ì œ
rm -f "$LOCK_FILE"
```

---

### 3. Log Rotation ì„¤ì •

```bash
# Logrotate ì„¤ì •
sudo nano /etc/logrotate.d/heeling-auto-deploy
```

**ë‚´ìš©**:
```
/var/log/heeling-auto-deploy.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 user user
}
```

**í…ŒìŠ¤íŠ¸**:
```bash
# Dry run
sudo logrotate -d /etc/logrotate.d/heeling-auto-deploy

# Force rotation
sudo logrotate -f /etc/logrotate.d/heeling-auto-deploy
```

---

### 4. ëª¨ë‹ˆí„°ë§

```bash
# ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
tail -f /var/log/heeling-auto-deploy.log

# ìµœê·¼ ë°°í¬ í™•ì¸
grep "âœ… Track created" /var/log/heeling-auto-deploy.log | tail -20

# ì—ëŸ¬ í™•ì¸
grep "âŒ" /var/log/heeling-auto-deploy.log | tail -20

# Cron ì‹¤í–‰ í™•ì¸
grep CRON /var/log/syslog | grep heeling
```

---

### 5. Slack ì•Œë¦¼ (ì„ íƒ)

```bash
# .envì— ì¶”ê°€
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/T00/B00/XXX"
```

**ì•Œë¦¼ ë°œì†¡ ì‹œì **:
- âœ… ë°°í¬ ì„±ê³µ (Track ìƒì„± ì™„ë£Œ)
- âŒ ìµœì¢… ì‹¤íŒ¨ (max retries ë„ë‹¬)
- ğŸ§Ÿ Zombie timeout
- ğŸš¨ Fatal error (ìŠ¤í¬ë¦½íŠ¸ í¬ë˜ì‹œ)

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: GenerationTaskê°€ PENDINGì—ì„œ ì§„í–‰ ì•ˆ ë¨

**ì›ì¸**:
- Suno API í‚¤ ì˜¤ë¥˜
- Suno ì„œë¹„ìŠ¤ ì¥ì• 
- ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ

**í•´ê²°**:
```bash
# 1. Suno API í‚¤ í™•ì¸
echo $SUNO_API_KEY

# 2. ìˆ˜ë™ìœ¼ë¡œ Suno ìƒíƒœ ì²´í¬
curl "https://api.sunoaiapi.com/api/v1/gateway/query?ids=taskIdì—¬ê¸°" \
  -H "api-key: $SUNO_API_KEY"

# 3. DBì—ì„œ Task í™•ì¸
psql $DATABASE_URL -c "SELECT id, taskId, status, error FROM \"GenerationTask\" WHERE status='PENDING';"

# 4. ìˆ˜ë™ìœ¼ë¡œ FAILED ì²˜ë¦¬ (í•„ìš” ì‹œ)
psql $DATABASE_URL -c "UPDATE \"GenerationTask\" SET status='FAILED', error='Manual intervention' WHERE id='task_id_here';"
```

---

### ë¬¸ì œ 2: ì œëª© ìºì‹œ ë¶€ì¡±

**ì¦ìƒ**:
```
[Schedule Run] Not enough titles in cache (1/2), using fallback
```

**í•´ê²°**:
```bash
# 1. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ "50ê°œ ìƒì„±" ë²„íŠ¼ í´ë¦­

# 2. ë˜ëŠ” API ì§ì ‘ í˜¸ì¶œ
curl -X POST http://localhost:3002/api/admin/generate/titles \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "category": "healing",
    "mood": "calm",
    "style": "piano",
    "count": 50
  }'
```

---

### ë¬¸ì œ 3: Gemini ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨

**ì¦ìƒ**:
```
[Deploy] Gemini image generation failed (non-critical): API key invalid
```

**í•´ê²°**:
```bash
# 1. GEMINI_API_KEY í™•ì¸
echo $GEMINI_API_KEY

# 2. Gemini API í‚¤ ê¶Œí•œ í™•ì¸
# https://aistudio.google.com/app/apikey

# 3. ì´ë¯¸ì§€ ì—†ì´ ë°°í¬ëŠ” ì •ìƒ ì§„í–‰ë¨ (thumbnailUrl = null)
```

---

### ë¬¸ì œ 4: Lock íŒŒì¼ ë¬¸ì œ

**ì¦ìƒ**:
```
Another instance is running (lock file exists)
```

**í•´ê²°**:
```bash
# 1. Lock íŒŒì¼ í™•ì¸
ls -la /tmp/heeling-auto-deploy.lock

# 2. Lock íŒŒì¼ ë‚˜ì´ í™•ì¸
stat /tmp/heeling-auto-deploy.lock

# 3. Stale lock ì œê±° (30ë¶„ ì´ìƒ)
rm -f /tmp/heeling-auto-deploy.lock

# 4. Wrapper scriptì— ìë™ stale lock ì œê±° ë¡œì§ ìˆìŒ
```

---

### ë¬¸ì œ 5: Duration ì¶”ì¶œ ì‹¤íŒ¨

**ì¦ìƒ**:
```
[Deploy] Duration extraction failed: Invalid audio format
```

**í•´ê²°**:
```bash
# 1. music-metadata ì„¤ì¹˜ í™•ì¸
npm list music-metadata

# 2. ì˜¤ë””ì˜¤ íŒŒì¼ ì§ì ‘ í™•ì¸
file public/media/tracks/abc123_0.mp3

# 3. FFmpegë¡œ duration ì¶”ì¶œ (ëŒ€ì•ˆ)
ffprobe -v error -show_entries format=duration \
  -of default=noprint_wrappers=1:nokey=1 \
  public/media/tracks/abc123_0.mp3
```

---

## ì„±ëŠ¥ ìµœì í™”

### 1. ë³‘ë ¬ ì²˜ë¦¬

**í˜„ì¬**:
- taskIdë³„ ìˆœì°¨ ì²˜ë¦¬
- ë™ì¼ taskId ë‚´ 2ê°œ íŠ¸ë™ ìˆœì°¨ ì²˜ë¦¬

**ìµœì í™” ê°€ëŠ¥**:
```javascript
// ë‹¤ë¥¸ taskIdëŠ” ë³‘ë ¬ ì²˜ë¦¬
const taskGroups = groupByTaskId(tasks);
await Promise.all(
  taskGroups.map(group => processTaskGroup(group))
);

// ê°™ì€ taskId ë‚´ 2ê°œ íŠ¸ë™ë„ ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥
await Promise.all(
  tasks.map(task => downloadAndDeployOne(task, sunoData))
);
```

---

### 2. ìºì‹±

**Gemini ì´ë¯¸ì§€ ìºì‹±**:
```javascript
// ë™ì¼ ì œëª©ìœ¼ë¡œ ì¬ìƒì„± ì‹œ ìºì‹œ í™œìš©
const cacheKey = `gemini_image_${title}`;
const cached = await redis.get(cacheKey);
if (cached) return cached;

const image = await generateGeminiImage(title);
await redis.set(cacheKey, image, 'EX', 86400); // 24ì‹œê°„
```

---

### 3. ë¦¬ì†ŒìŠ¤ ì œí•œ

```javascript
// check-and-deploy.js CONFIG
const CONFIG = {
  MAX_CONCURRENT_TASKS: 3,      // ë™ì‹œ ì²˜ë¦¬ Task ìˆ˜
  ZOMBIE_TIMEOUT_HOURS: 1,      // Zombie timeout
  RETRY_DELAY_MS: 1000,         // Retry ê°„ê²©
  DOWNLOAD_TIMEOUT_MS: 30000,   // ë‹¤ìš´ë¡œë“œ timeout
};
```

---

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. API í‚¤ ë³´ì•ˆ

```bash
# .env íŒŒì¼ ê¶Œí•œ
chmod 600 .env

# Git ignore
echo ".env" >> .gitignore
```

---

### 2. íŒŒì¼ ì—…ë¡œë“œ ê²€ì¦

```javascript
// check-and-deploy.js
async function saveToLocal(buffer, filename, directory) {
  // íŒŒì¼ëª… sanitize
  const safeFilename = filename
    .replace(/[^a-zA-Z0-9._-]/g, '_')
    .substring(0, 100);

  // íŒŒì¼ í¬ê¸° ì œí•œ (50MB)
  if (buffer.length > 50 * 1024 * 1024) {
    throw new Error('File too large');
  }

  // ...
}
```

---

### 3. SQL Injection ë°©ì§€

```javascript
// Prisma ORM ì‚¬ìš© (ìë™ parameterization)
await prisma.generationTask.findMany({
  where: { taskId: userInput }  // âœ… Safe
});

// Raw query ì‚¬ìš© ê¸ˆì§€
await prisma.$executeRaw`SELECT * FROM Track WHERE id = ${userInput}`;  // âŒ Unsafe
```

---

## ë§ˆë¬´ë¦¬

### í•µì‹¬ í¬ì¸íŠ¸

1. **ì œëª© ìºì‹œ**: ìˆ˜ë™/ìë™ ìƒì„± ëª¨ë‘ ê³µìœ 
2. **2íŠ¸ë™ ì²˜ë¦¬**: Suno 1íšŒ í˜¸ì¶œ = 2ê°œ íŠ¸ë™ ë°°í¬
3. **ìƒíƒœ ì¶”ì **: PENDING â†’ DEPLOYED (6ë‹¨ê³„)
4. **ì—ëŸ¬ ì²˜ë¦¬**: Retry 3íšŒ, Zombie 1ì‹œê°„
5. **ìë™í™”**: Cron 5ë¶„ë§ˆë‹¤ ì‹¤í–‰

### ì²´í¬ë¦¬ìŠ¤íŠ¸

**ë¡œì»¬ í…ŒìŠ¤íŠ¸**:
- [ ] ì œëª© ìºì‹œ 167ê°œ í™•ì¸
- [ ] ìŠ¤ì¼€ì¤„ ì‹¤í–‰ â†’ 2ê°œ GenerationTask ìƒì„±
- [ ] npm run deploy:check ì‹¤í–‰
- [ ] 2ê°œ Track ìƒì„± í™•ì¸

**VPS ë°°í¬**:
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (.env)
- [ ] Crontab ì„¤ì • (*/5 * * * *)
- [ ] Log rotation ì„¤ì •
- [ ] ëª¨ë‹ˆí„°ë§ ì„¤ì •

**ì•Œë¦¼ (ì„ íƒ)**:
- [ ] Slack webhook ì„¤ì •
- [ ] í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡

---

**ì‘ì„±ì¼**: 2024-12-03
**ë²„ì „**: 1.0
**ë¬¸ì„œ ê´€ë¦¬**: ì‹œìŠ¤í…œ ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ í•„ìš”
